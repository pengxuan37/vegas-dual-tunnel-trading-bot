# 执行计划

# AI/开发执行计划：维加斯双隧道Telegram机器人

## 项目概述

根据V2.1需求文档，构建一个集行情分析、多网络环境交易执行和用户交互于一体的自动化Go语言交易机器人。

## 阶段一：环境搭建与核心框架 (Foundations)

此阶段的目标是搭建一个可运行的基础机器人程序，包含数据库和API客户端的雏形。

- **任务 1.1: 项目初始化**
    - [ ] 初始化Go Modules项目
    - [ ] 建立清晰的目录结构 (e.g., `/cmd`, `/internal`, `/pkg`, `/configs`)
    - [ ] 引入并配置日志库 (e.g., `logrus`, `zap`)
    - [ ] 引入并配置环境变量管理库 (e.g., `godotenv`)
    - [ ] **新增**: 创建配置文件管理模块，支持YAML/JSON配置文件读取
    - [ ] **新增**: 设计全局错误处理和恢复机制
- **任务 1.2: Telegram机器人集成**
    - [ ] 引入Go Telegram Bot API库 (e.g., `go-telegram-bot-api/telegram-bot-api`)
    - [ ] 实现一个基础的机器人主循环，能接收并响应消息
    - [ ] 实现基础指令处理器，用于响应 `/start` 和 `/help` 命令
    - [ ] **新增**: 实现半自动模式的内联键盘确认机制
    - [ ] **新增**: 实现消息删除功能（用于API密钥安全）
- **任务 1.3: 数据库初始化**
    - [ ] 引入 `database/sql` 和 `mattn/go-sqlite3` 库
    - [ ] 编写SQL脚本，创建数据库表：
        - [ ] `monitored_contracts` (id, symbol, is_active, created_at)
        - [ ] `user_settings` (user_id, api_key_encrypted, secret_key_encrypted, network_mode, trade_mode, position_size_type, position_size_value, created_at, updated_at)
        - [ ] `trades` (id, user_id, symbol, direction, entry_price, sl_price, tp1_price, tp2_price, quantity, status, network, binance_order_id, open_timestamp, close_timestamp, pnl, notes)
        - [ ] **新增**: `kline_data` (symbol, interval, open_time, close_time, open, high, low, close, volume) - 用于缓存历史数据
        - [ ] **新增**: `system_logs` (id, level, message, timestamp) - 用于系统日志记录
    - [ ] 编写数据库初始化和连接模块
    - [ ] **新增**: 实现数据库迁移机制，支持版本升级
- **任务 1.4: 币安API客户端**
    - [ ] 引入HTTP客户端库
    - [ ] 封装币安REST API客户端，实现获取历史K线 (`/api/v3/klines`) 的功能
    - [ ] 封装币安WebSocket API客户端，实现订阅指定合约的K线数据流 (`<symbol>@kline_<interval>`) 的功能
    - [ ] **新增**: 实现API限流控制和重试机制
    - [ ] **新增**: 实现主网/测试网环境自动切换
    - [ ] **新增**: 添加连接健康检查和自动重连机制
    - [ ] **新增**: 历史数据初始化策略 - 获取足够的K线数据以计算EMA338（建议至少1000根K线）

## 阶段二：策略实现与信号生成 (Strategy & Signals)

此阶段专注于将交易策略的数学逻辑和多时间周期分析转化为代码。

- **任务 2.1: 指标计算模块**
    - [ ] 实现一个通用的EMA（指数移动平均线）计算函数
    - [ ] 创建一个策略计算器，能够接收K线数据并实时更新EMA 12, 144, 169, 288, 338的值
    - [ ] **新增**: 实现EMA计算的优化算法，支持增量更新
    - [ ] **新增**: 添加指标计算的单元测试和验证机制
- **任务 2.2: 多时间周期分析引擎**
    - [ ] 创建一个数据管理器，能同时维护同一个合约的15M和4H K线数据及对应的EMA指标
    - [ ] 实现4H周期的宏观状态判断逻辑（绝对多头/空头/震荡）
    - [ ] **新增**: 实现K线数据的内存管理，避免内存泄漏
    - [ ] **新增**: 添加数据同步机制，确保15M和4H数据的一致性
- **任务 2.3: 信号生成器**
    - [ ] 当接收到15M的K线关闭事件时，触发信号检查
    - [ ] 编写信号检查函数，严格按照文档中的"多头/空头入场信号"条件进行判断
    - [ ] 当信号生成时，将信号（包含合约、方向、价格等信息）推送到一个内部事件通道中
    - [ ] **新增**: 实现信号去重机制，避免重复信号
    - [ ] **新增**: 添加信号强度评估和过滤机制

## 阶段三：机器人功能与交互 (Features & Interaction)

此阶段将所有面向用户的功能指令实现，并打通信号通知流程。

- **任务 3.1: 用户指令实现**
    - [ ] 实现 `/add`, `/remove`, `/list` 指令，并与数据库交互
    - [ ] 实现 `/setnetwork`, `/network` 指令，更新 `user_settings` 表
    - [ ] 实现 `/setmode` 指令，更新 `user_settings` 表
    - [ ] 实现 `/setkey` 指令，包含消息删除和API密钥加密存储逻辑
    - [ ] 实现 `/setsize` 指令，更新仓位配置
    - [ ] **新增**: 实现 `/help` 指令，显示所有可用命令和使用说明
    - [ ] **新增**: 实现指令参数验证和错误提示
    - [ ] **新增**: 添加指令权限控制，确保只有授权用户可以操作
- **任务 3.2: 通知模块**
    - [ ] 创建一个专门的通知发送模块，监听内部信号事件通道
    - [ ] 编写不同类型的通知消息模板（入场、平仓、失败、更新等）
    - [ ] 实现当收到信号时，根据用户设置的模式 (`signal_only`, `semi_auto`, `full_auto`) 发送对应的通知
    - [ ] **新增**: 实现通知模板系统，支持自定义通知格式
    - [ ] **新增**: 添加通知发送失败重试机制
- **任务 3.3: 状态与统计**
    - [ ] 实现 `/status` 指令，查询数据库中状态为 `active` 的 `trades` 并结合实时价格计算浮动盈亏
    - [ ] 实现 `/summary` 指令，根据时间范围查询 `trades` 表并进行统计计算
    - [ ] 实现每日心跳服务（可使用Go Ticker实现）
    - [ ] **新增**: 实现性能指标计算（胜率、盈亏比、最大回撤等）
    - [ ] **新增**: 添加数据导出功能，支持CSV格式

## 阶段四：交易执行 (Trade Execution)

此阶段是项目的核心，处理所有与真实资金和订单相关的逻辑。

- **任务 4.1: 订单管理模块**
    - [ ] 扩展币安API客户端，实现下单 (New Order)、查询订单 (Query Order)、取消订单 (Cancel Order) 等功能
    - [ ] 确保客户端能处理主网和测试网的不同API endpoint
    - [ ] **新增**: 实现订单状态实时查询和更新机制
    - [ ] **新增**: 添加交易手续费计算和记录
    - [ ] **新增**: 实现滑点控制和价格保护机制
- **任务 4.2: 开仓逻辑**
    - [ ] 实现开仓执行器，监听内部信号事件
    - [ ] 根据用户是否配置API Key，自动选择主网或测试网执行下单
    - [ ] 下单后，将成交信息（包括网络环境）存入 `trades` 数据库表
    - [ ] 发送包含订单状态和账户信息的成功/失败通知
    - [ ] **新增**: 实现仓位大小计算和风险控制
    - [ ] **新增**: 添加开仓前的资金充足性检查
    - [ ] **新增**: 实现开仓失败的异常处理和通知
- **任务 4.3: 平仓逻辑**
    - [ ] 创建一个独立的仓位监控服务，持续监控所有 `active` 的交易
    - [ ] 监控逻辑包含：检查价格是否触达TP1、是否触达SL、是否触发EMA12移动止盈
    - [ ] **实现平仓前的订单校验逻辑**：必须先查询数据库确认订单存在且活跃
    - [ ] 根据查询到的开仓网络，在对应的网络执行平仓
    - [ ] 实现平仓失败的重试机制和最终的失败告警通知
    - [ ] **新增**: 实现部分平仓功能（TP1时平仓50%）
    - [ ] **新增**: 添加止损单自动跟踪和更新机制
    - [ ] **新增**: 实现紧急平仓功能（手动强制平仓）

## 阶段五：测试与部署 (Testing & Deployment)

- **任务 5.1: 单元测试**
    - [ ] 为核心模块（EMA计算、信号生成、数据库操作）编写单元测试
    - [ ] **新增**: 实现测试数据生成器，模拟各种市场情况
    - [ ] **新增**: 添加性能测试，确保系统在高频数据下的稳定性
    - [ ] **新增**: 实现Mock测试，模拟币安API响应
- **任务 5.2: 集成测试**
    - [ ] 在币安测试网进行端到端的集成测试
    - [ ] 测试所有Telegram指令的响应是否正确
    - [ ] **新增**: 实现自动化测试脚本，覆盖所有交易场景
    - [ ] **新增**: 添加压力测试，验证系统并发处理能力
    - [ ] **新增**: 实现回测功能，验证策略历史表现
- **任务 5.3: 部署准备**
     - ~~[ ] 编写 `Dockerfile` 和部署文档~~
     - ~~[ ] **新增**: 创建Docker Compose配置，简化部署流程~~
     - [ ] **新增**: 编写监控和日志收集配置
     - [ ] **新增**: 实现健康检查和自动重启机制
     - [ ] **新增**: 创建备份和恢复策略文档
     - [ ] **新增**: 编写服务器直接部署文档和启动脚本
     - [ ] **新增**: 创建systemd服务配置文件（用于Linux服务器自启动）